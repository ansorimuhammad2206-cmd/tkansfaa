<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kasir Esteh Santri</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background-color: #2e7d32;
            color: white;
            padding: 15px 0;
            border-radius: 8px 8px 0 0;
            text-align: center;
            margin-bottom: 20px;
        }
        
        .app-title {
            font-size: 24px;
            font-weight: bold;
        }
        
        .app-subtitle {
            font-size: 16px;
            opacity: 0.9;
        }
        
        .navigation {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .nav-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            background: #f5f5f5;
            color: #333;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .nav-btn.active {
            background: #2e7d32;
            color: white;
        }
        
        .nav-btn:hover {
            background: #1b5e20;
            color: white;
        }
        
        .main-content {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }
        
        .menu-section {
            flex: 2;
            min-width: 300px;
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .cart-section {
            flex: 1;
            min-width: 300px;
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .dashboard-section {
            flex: 1;
            min-width: 300px;
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: none;
        }
        
        .dashboard-section.active {
            display: block;
        }
        
        .section-title {
            font-size: 18px;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #2e7d32;
            color: #2e7d32;
        }
        
        .category-tabs {
            display: flex;
            margin-bottom: 15px;
            border-bottom: 1px solid #ddd;
        }
        
        .category-tab {
            padding: 10px 15px;
            cursor: pointer;
            border: none;
            background: none;
            font-weight: bold;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }
        
        .category-tab.active {
            color: #2e7d32;
            border-bottom: 3px solid #2e7d32;
        }
        
        .category-tab:hover {
            color: #2e7d32;
        }
        
        .menu-category {
            display: none;
        }
        
        .menu-category.active {
            display: block;
        }
        
        .menu-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 15px;
        }
        
        .menu-item {
            background: #f9f9f9;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            border: 1px solid #e0e0e0;
        }
        
        .menu-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            border-color: #2e7d32;
        }
        
        .menu-item.selected {
            background-color: #e8f5e9;
            border-color: #2e7d32;
        }
        
        .item-name {
            font-weight: bold;
            margin-bottom: 5px;
            font-size: 14px;
        }
        
        .item-price {
            color: #2e7d32;
            font-weight: bold;
            font-size: 13px;
        }
        
        .cart-items {
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 20px;
        }
        
        .cart-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }
        
        .cart-item-details {
            flex: 1;
        }
        
        .cart-item-name {
            font-weight: bold;
            font-size: 14px;
        }
        
        .cart-item-category {
            font-size: 11px;
            color: #888;
            margin-top: 2px;
        }
        
        .cart-item-price {
            color: #2e7d32;
            font-size: 13px;
        }
        
        .cart-item-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .quantity-btn {
            background: #2e7d32;
            color: white;
            border: none;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .quantity {
            font-weight: bold;
            min-width: 30px;
            text-align: center;
        }
        
        .remove-btn {
            background: #f44336;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .cart-total {
            font-size: 20px;
            font-weight: bold;
            text-align: right;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 2px solid #2e7d32;
        }
        
        .payment-section {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }
        
        .payment-input {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .payment-input label {
            min-width: 80px;
        }
        
        .payment-input input {
            flex: 1;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .change-display {
            font-weight: bold;
            text-align: right;
            margin-top: 10px;
            padding: 10px;
            background: #e8f5e9;
            border-radius: 4px;
            display: none;
        }
        
        .cart-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: #2e7d32;
            color: white;
        }
        
        .btn-primary:hover {
            background: #1b5e20;
        }
        
        .btn-secondary {
            background: #f5f5f5;
            color: #333;
            border: 1px solid #ddd;
        }
        
        .btn-secondary:hover {
            background: #e0e0e0;
        }
        
        .receipt {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: none;
            max-width: 300px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .receipt-header {
            text-align: center;
            margin-bottom: 15px;
            border-bottom: 1px dashed #333;
            padding-bottom: 10px;
        }
        
        .store-logo {
            font-size: 40px;
            margin-bottom: 10px;
        }
        
        .store-name {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .store-slogan {
            font-size: 14px;
            margin-bottom: 5px;
        }
        
        .store-address {
            font-size: 12px;
            margin-bottom: 10px;
        }
        
        .receipt-items {
            margin-bottom: 15px;
        }
        
        .receipt-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 14px;
        }
        
        .receipt-totals {
            border-top: 1px dashed #333;
            padding-top: 10px;
            margin-top: 10px;
        }
        
        .receipt-total-line {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }
        
        .receipt-total {
            font-weight: bold;
            border-top: 1px solid #333;
            padding-top: 5px;
            margin-top: 5px;
            display: flex;
            justify-content: space-between;
        }
        
        .receipt-change {
            font-weight: bold;
            color: #2e7d32;
        }
        
        .receipt-footer {
            text-align: center;
            margin-top: 15px;
            font-size: 12px;
            border-top: 1px dashed #333;
            padding-top: 10px;
        }
        
        /* Dashboard Styles */
        .dashboard-tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
        }
        
        .dashboard-tab {
            padding: 10px 20px;
            cursor: pointer;
            border: none;
            background: none;
            font-weight: bold;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }
        
        .dashboard-tab.active {
            color: #2e7d32;
            border-bottom: 3px solid #2e7d32;
        }
        
        .dashboard-content {
            display: none;
        }
        
        .dashboard-content.active {
            display: block;
        }
        
        .income-card {
            background: #f9f9f9;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 4px solid #2e7d32;
        }
        
        .income-period {
            font-weight: bold;
            margin-bottom: 10px;
            color: #2e7d32;
        }
        
        .income-amount {
            font-size: 24px;
            font-weight: bold;
            color: #333;
        }
        
        .income-list {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .income-item {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .income-date {
            font-weight: bold;
        }
        
        .income-total {
            color: #2e7d32;
            font-weight: bold;
        }
        
        .no-data {
            text-align: center;
            color: #888;
            padding: 20px;
        }

        /* TAMBAHAN STYLE UNTUK FITUR KATEGORI */
        .category-breakdown {
            margin-top: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 5px;
        }

        .category-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            padding-bottom: 5px;
            border-bottom: 1px solid #e9ecef;
        }

        .category-name {
            font-weight: 500;
        }

        .category-amount {
            color: #2e7d32;
            font-weight: bold;
        }

        .category-total {
            font-weight: bold;
            border-top: 2px solid #2e7d32;
            padding-top: 8px;
            margin-top: 8px;
        }

        /* SOLUSI CETAK YANG LEBIH SEDERHANA */
        @media print {
            /* Sembunyikan semua elemen body */
            body > *:not(#receipt) {
                display: none !important;
            }
            
            /* Tampilkan hanya struk */
            #receipt {
                display: block !important;
                position: static !important;
                width: 100% !important;
                max-width: 100% !important;
                margin: 0 !important;
                padding: 0 !important;
                box-shadow: none !important;
                border: none !important;
                border-radius: 0 !important;
                background: white !important;
            }
            
            /* Sembunyikan tombol pada struk */
            #receipt .cart-actions {
                display: none !important;
            }
            
            /* Atur ukuran font untuk cetak */
            #receipt {
                font-size: 12pt !important;
            }
            
            #receipt .receipt-header {
                margin-bottom: 10px !important;
                padding-bottom: 5px !important;
            }
            
            #receipt .store-logo {
                font-size: 30px !important;
                margin-bottom: 5px !important;
            }
            
            #receipt .store-name {
                font-size: 18px !important;
            }
            
            #receipt .store-slogan, #receipt .store-address {
                font-size: 11px !important;
            }
            
            #receipt .receipt-item {
                font-size: 12px !important;
                margin-bottom: 3px !important;
            }
            
            #receipt .receipt-footer {
                font-size: 10px !important;
                margin-top: 10px !important;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="app-title">Kasir Toko ANSFAA</div>
            <div class="app-subtitle">Sistem Kasir untuk Usaha Minuman, Makanan & Alat Tulis</div>
        </header>
        
        <div class="navigation">
            <button class="nav-btn active" data-section="kasir">Kasir</button>
            <button class="nav-btn" data-section="dashboard">Dashboard Pendapatan</button>
        </div>
        
        <div class="main-content">
            <div class="menu-section" id="kasir-section">
                <h2 class="section-title">Menu</h2>
                
                <div class="category-tabs">
                    <button class="category-tab active" data-category="minuman">Minuman</button>
                    <button class="category-tab" data-category="makanan">Makanan</button>
                    <button class="category-tab" data-category="alat-tulis">Alat Tulis</button>
                </div>
                
                <div class="menu-category active" id="minuman">
                    <h3 style="margin-bottom: 15px; color: #2e7d32;">Menu Minuman</h3>
                    <div class="menu-grid" id="menuMinuman">
                        <!-- Menu minuman akan diisi oleh JavaScript -->
                    </div>
                </div>
                
                <div class="menu-category" id="makanan">
                    <h3 style="margin-bottom: 15px; color: #2e7d32;">Menu Makanan</h3>
                    <div class="menu-grid" id="menuMakanan">
                        <!-- Menu makanan akan diisi oleh JavaScript -->
                    </div>
                </div>
                
                <div class="menu-category" id="alat-tulis">
                    <h3 style="margin-bottom: 15px; color: #2e7d32;">Alat Tulis</h3>
                    <div class="menu-grid" id="menuAlatTulis">
                        <!-- Menu alat tulis akan diisi oleh JavaScript -->
                    </div>
                </div>
            </div>
            
            <div class="cart-section" id="cart-section">
                <h2 class="section-title">Keranjang Belanja</h2>
                <div class="cart-items" id="cartItems">
                    <!-- Cart items will be populated by JavaScript -->
                </div>
                
                <div class="cart-total">
                    Total: Rp <span id="totalAmount">0</span>
                </div>
                
                <div class="payment-section">
                    <div class="payment-input">
                        <label for="cashAmount">Tunai:</label>
                        <input type="number" id="cashAmount" placeholder="Masukkan jumlah tunai">
                    </div>
                    <div class="change-display" id="changeDisplay">
                        Kembalian: Rp <span id="changeAmount">0</span>
                    </div>
                </div>
                
                <div class="cart-actions">
                    <button class="btn btn-secondary" id="clearCart">Hapus Semua</button>
                    <button class="btn btn-primary" id="checkout">Proses Pembayaran</button>
                </div>
            </div>
            
            <div class="dashboard-section" id="dashboard-section">
                <h2 class="section-title">Dashboard Pendapatan</h2>
                
                <div class="dashboard-tabs">
                    <button class="dashboard-tab active" data-tab="harian">Harian</button>
                    <button class="dashboard-tab" data-tab="bulanan">Bulanan</button>
                    <button class="dashboard-tab" data-tab="tahunan">Tahunan</button>
                    <!-- TAB BARU UNTUK KATEGORI -->
                    <button class="dashboard-tab" data-tab="kategori">Per Kategori</button>
                </div>
                
                <div class="dashboard-content active" id="harian-content">
                    <h3 style="margin-bottom: 15px; color: #2e7d32;">Pendapatan Harian</h3>
                    <div class="income-list" id="dailyIncomeList">
                        <!-- Data pendapatan harian akan diisi oleh JavaScript -->
                    </div>
                </div>
                
                <div class="dashboard-content" id="bulanan-content">
                    <h3 style="margin-bottom: 15px; color: #2e7d32;">Pendapatan Bulanan</h3>
                    <div class="income-list" id="monthlyIncomeList">
                        <!-- Data pendapatan bulanan akan diisi oleh JavaScript -->
                    </div>
                </div>
                
                <div class="dashboard-content" id="tahunan-content">
                    <h3 style="margin-bottom: 15px; color: #2e7d32;">Pendapatan Tahunan</h3>
                    <div class="income-list" id="yearlyIncomeList">
                        <!-- Data pendapatan tahunan akan diisi oleh JavaScript -->
                    </div>
                </div>
                
                <!-- CONTENT BARU UNTUK KATEGORI -->
                <div class="dashboard-content" id="kategori-content">
                    <h3 style="margin-bottom: 15px; color: #2e7d32;">Pendapatan Per Kategori</h3>
                    <div class="income-list" id="categoryIncomeList">
                        <!-- Data pendapatan per kategori akan diisi oleh JavaScript -->
                    </div>
                </div>
            </div>
        </div>
        
        <div class="receipt" id="receipt">
            <div class="receipt-header">
                <div class="store-logo">🍵</div>
                <div class="store-name">Esteh Santri</div>
                <div class="store-slogan">Segar, Nikmat,Berkah</div>
                <div class="store-address">Jl. Kenanga No. 22, Ds. Bolo, Kec. Demak</div>
                <div id="receiptDate"></div>
            </div>
            
            <div class="receipt-items" id="receiptItems">
                <!-- Receipt items will be populated by JavaScript -->
            </div>
            
            <div class="receipt-totals">
                <div class="receipt-total-line">
                    <span>Total:</span>
                    <span>Rp <span id="receiptTotal">0</span></span>
                </div>
                <div class="receipt-total-line">
                    <span>Tunai:</span>
                    <span>Rp <span id="receiptCash">0</span></span>
                </div>
                <div class="receipt-total-line receipt-change">
                    <span>Kembalian:</span>
                    <span>Rp <span id="receiptChange">0</span></span>
                </div>
            </div>
            
            <div class="receipt-footer">
                Terima kasih atas kunjungan Anda<br>
                Selamat menikmati minuman kami!
            </div>
            
            <div class="cart-actions" style="margin-top: 20px;">
                <button class="btn btn-secondary" id="closeReceipt">Tutup</button>
                <button class="btn btn-primary" id="printReceipt">Cetak</button>
            </div>
        </div>
    </div>

    <script>
        // Menu data dengan kategori
        const menuItems = {
            minuman: [
                { id: 1, name: "Es Teh Manis", price: 5000, category: "minuman" },
                { id: 2, name: "Es Teh Lemon", price: 7000, category: "minuman" },
                { id: 3, name: "Es Jeruk", price: 8000, category: "minuman" },
                { id: 4, name: "Jus Alpukat", price: 12000, category: "minuman" },
                { id: 5, name: "Jus Mangga", price: 10000, category: "minuman" },
                { id: 6, name: "Kopi Susu", price: 8000, category: "minuman" },
                { id: 7, name: "Milkshake Coklat", price: 15000, category: "minuman" },
                { id: 8, name: "Milkshake Vanilla", price: 15000, category: "minuman" },
                { id: 9, name: "Es Cincau", price: 10000, category: "minuman" },
                { id: 10, name: "Es Kelapa Muda", price: 12000, category: "minuman" },
                { id: 11, name: "Thai Tea", price: 13000, category: "minuman" },
                { id: 12, name: "Red Velvet", price: 14000, category: "minuman" }
            ],
            makanan: [
                { id: 13, name: "Roti Bakar Coklat", price: 8000, category: "makanan" },
                { id: 14, name: "Roti Bakar Keju", price: 10000, category: "makanan" },
                { id: 15, name: "Roti Bakar Special", price: 12000, category: "makanan" },
                { id: 16, name: "Mie Instan Rebus", price: 7000, category: "makanan" },
                { id: 17, name: "Mie Instan Goreng", price: 7000, category: "makanan" },
                { id: 18, name: "Indomie Telur", price: 10000, category: "makanan" },
                { id: 19, name: "Kentang Goreng", price: 8000, category: "makanan" },
                { id: 20, name: "Singkong Goreng", price: 6000, category: "makanan" },
                { id: 21, name: "Pisang Goreng", price: 5000, category: "makanan" },
                { id: 22, name: "Tahu Isi", price: 4000, category: "makanan" }
            ],
            "alat-tulis": [
                { id: 23, name: "Pulpen Standard", price: 3000, category: "alat-tulis" },
                { id: 24, name: "Pulpen Pilot", price: 5000, category: "alat-tulis" },
                { id: 25, name: "Buku Tulis 38 Lbr", price: 4000, category: "alat-tulis" },
                { id: 26, name: "Buku Tulis 58 Lbr", price: 6000, category: "alat-tulis" },
                { id: 27, name: "Pensil 2B", price: 2500, category: "alat-tulis" },
                { id: 28, name: "Penghapus", price: 2000, category: "alat-tulis" },
                { id: 29, name: "Penggaris 30cm", price: 3000, category: "alat-tulis" },
                { id: 30, name: "Spidol Whiteboard", price: 7000, category: "alat-tulis" },
                { id: 31, name: "Stabilo", price: 8000, category: "alat-tulis" },
                { id: 32, name: "Correction Tape", price: 10000, category: "alat-tulis" }
            ]
        };

        // Cart data
        let cart = [];
        
        // Income data structure - DIPERBAIKI UNTUK KATEGORI
        let incomeData = {
            daily: {},           // Format: "YYYY-MM-DD": {total: number, categories: {minuman: number, makanan: number, alat-tulis: number}}
            monthly: {},         // Format: "YYYY-MM": {total: number, categories: {...}}
            yearly: {},          // Format: "YYYY": {total: number, categories: {...}}
            categories: {        // Total keseluruhan per kategori
                minuman: 0,
                makanan: 0,
                "alat-tulis": 0
            }
        };
        
        // DOM elements
        const menuMinuman = document.getElementById('menuMinuman');
        const menuMakanan = document.getElementById('menuMakanan');
        const menuAlatTulis = document.getElementById('menuAlatTulis');
        const cartItems = document.getElementById('cartItems');
        const totalAmount = document.getElementById('totalAmount');
        const cashAmountInput = document.getElementById('cashAmount');
        const changeDisplay = document.getElementById('changeDisplay');
        const changeAmount = document.getElementById('changeAmount');
        const clearCartBtn = document.getElementById('clearCart');
        const checkoutBtn = document.getElementById('checkout');
        const receipt = document.getElementById('receipt');
        const receiptItems = document.getElementById('receiptItems');
        const receiptTotal = document.getElementById('receiptTotal');
        const receiptCash = document.getElementById('receiptCash');
        const receiptChange = document.getElementById('receiptChange');
        const receiptDate = document.getElementById('receiptDate');
        const closeReceiptBtn = document.getElementById('closeReceipt');
        const printReceiptBtn = document.getElementById('printReceipt');
        const categoryTabs = document.querySelectorAll('.category-tab');
        const navBtns = document.querySelectorAll('.nav-btn');
        const dashboardTabs = document.querySelectorAll('.dashboard-tab');
        const dailyIncomeList = document.getElementById('dailyIncomeList');
        const monthlyIncomeList = document.getElementById('monthlyIncomeList');
        const yearlyIncomeList = document.getElementById('yearlyIncomeList');
        const categoryIncomeList = document.getElementById('categoryIncomeList'); // ELEMENT BARU

        // Initialize the app
        function init() {
            loadIncomeData();
            renderMenu();
            updateCart();
            setupCategoryTabs();
            setupNavigation();
            setupDashboardTabs();
            renderDashboard();
            
            // Event listeners
            clearCartBtn.addEventListener('click', clearCart);
            checkoutBtn.addEventListener('click', checkout);
            closeReceiptBtn.addEventListener('click', closeReceipt);
            printReceiptBtn.addEventListener('click', printReceipt);
            cashAmountInput.addEventListener('input', calculateChange);
        }

        // Load income data from localStorage - DIPERBAIKI
        function loadIncomeData() {
            const savedData = localStorage.getItem('estehSantriIncomeData');
            if (savedData) {
                incomeData = JSON.parse(savedData);
                
                // Backward compatibility: jika data lama tanpa kategori
                if (!incomeData.categories) {
                    incomeData.categories = {
                        minuman: 0,
                        makanan: 0,
                        "alat-tulis": 0
                    };
                    
                    // Convert data lama ke format baru
                    convertOldDataToNewFormat();
                }
            }
        }

        // Fungsi untuk convert data lama ke format baru
        function convertOldDataToNewFormat() {
            // Convert daily data
            Object.keys(incomeData.daily).forEach(date => {
                if (typeof incomeData.daily[date] === 'number') {
                    incomeData.daily[date] = {
                        total: incomeData.daily[date],
                        categories: { minuman: 0, makanan: 0, "alat-tulis": 0 }
                    };
                }
            });
            
            // Convert monthly data
            Object.keys(incomeData.monthly).forEach(month => {
                if (typeof incomeData.monthly[month] === 'number') {
                    incomeData.monthly[month] = {
                        total: incomeData.monthly[month],
                        categories: { minuman: 0, makanan: 0, "alat-tulis": 0 }
                    };
                }
            });
            
            // Convert yearly data
            Object.keys(incomeData.yearly).forEach(year => {
                if (typeof incomeData.yearly[year] === 'number') {
                    incomeData.yearly[year] = {
                        total: incomeData.yearly[year],
                        categories: { minuman: 0, makanan: 0, "alat-tulis": 0 }
                    };
                }
            });
            
            saveIncomeData();
        }

        // Save income data to localStorage
        function saveIncomeData() {
            localStorage.setItem('estehSantriIncomeData', JSON.stringify(incomeData));
        }

        // Setup navigation
        function setupNavigation() {
            navBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    // Remove active class from all buttons
                    navBtns.forEach(b => b.classList.remove('active'));
                    
                    // Add active class to clicked button
                    btn.classList.add('active');
                    
                    // Show selected section
                    const section = btn.getAttribute('data-section');
                    if (section === 'kasir') {
                        document.getElementById('kasir-section').style.display = 'block';
                        document.getElementById('cart-section').style.display = 'block';
                        document.getElementById('dashboard-section').style.display = 'none';
                    } else {
                        document.getElementById('kasir-section').style.display = 'none';
                        document.getElementById('cart-section').style.display = 'none';
                        document.getElementById('dashboard-section').style.display = 'block';
                        renderDashboard();
                    }
                });
            });
        }

        // Setup dashboard tabs - DIPERBAIKI
        function setupDashboardTabs() {
            dashboardTabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    // Remove active class from all tabs
                    dashboardTabs.forEach(t => t.classList.remove('active'));
                    
                    // Add active class to clicked tab
                    tab.classList.add('active');
                    
                    // Hide all contents
                    document.querySelectorAll('.dashboard-content').forEach(content => {
                        content.classList.remove('active');
                    });
                    
                    // Show selected content
                    const tabId = tab.getAttribute('data-tab');
                    document.getElementById(`${tabId}-content`).classList.add('active');
                    
                    // Jika tab kategori, render breakdown
                    if (tabId === 'kategori') {
                        renderCategoryBreakdown();
                    }
                });
            });
        }

        // Setup category tabs
        function setupCategoryTabs() {
            categoryTabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    // Remove active class from all tabs
                    categoryTabs.forEach(t => t.classList.remove('active'));
                    
                    // Add active class to clicked tab
                    tab.classList.add('active');
                    
                    // Hide all categories
                    document.querySelectorAll('.menu-category').forEach(cat => {
                        cat.classList.remove('active');
                    });
                    
                    // Show selected category
                    const category = tab.getAttribute('data-category');
                    document.getElementById(category).classList.add('active');
                });
            });
        }

        // Render menu items by category
        function renderMenu() {
            // Render minuman
            menuMinuman.innerHTML = '';
            menuItems.minuman.forEach(item => {
                const menuItem = createMenuItem(item);
                menuMinuman.appendChild(menuItem);
            });
            
            // Render makanan
            menuMakanan.innerHTML = '';
            menuItems.makanan.forEach(item => {
                const menuItem = createMenuItem(item);
                menuMakanan.appendChild(menuItem);
            });
            
            // Render alat tulis
            menuAlatTulis.innerHTML = '';
            menuItems["alat-tulis"].forEach(item => {
                const menuItem = createMenuItem(item);
                menuAlatTulis.appendChild(menuItem);
            });
        }

        // Create menu item element
        function createMenuItem(item) {
            const menuItem = document.createElement('div');
            menuItem.className = 'menu-item';
            menuItem.innerHTML = `
                <div class="item-name">${item.name}</div>
                <div class="item-price">Rp ${item.price.toLocaleString('id-ID')}</div>
            `;
            
            menuItem.addEventListener('click', () => addToCart(item));
            return menuItem;
        }

        // Add item to cart
        function addToCart(item) {
            const existingItem = cart.find(cartItem => cartItem.id === item.id);
            
            if (existingItem) {
                existingItem.quantity++;
            } else {
                cart.push({
                    id: item.id,
                    name: item.name,
                    price: item.price,
                    category: item.category,
                    quantity: 1
                });
            }
            
            updateCart();
        }

        // Remove item from cart
        function removeFromCart(itemId) {
            cart = cart.filter(item => item.id !== itemId);
            updateCart();
        }

        // Update item quantity
        function updateQuantity(itemId, change) {
            const item = cart.find(item => item.id === itemId);
            
            if (item) {
                item.quantity += change;
                
                if (item.quantity <= 0) {
                    removeFromCart(itemId);
                } else {
                    updateCart();
                }
            }
        }

        // Update cart display
        function updateCart() {
            cartItems.innerHTML = '';
            
            if (cart.length === 0) {
                cartItems.innerHTML = '<p style="text-align: center; color: #888;">Keranjang kosong</p>';
                totalAmount.textContent = '0';
                changeDisplay.style.display = 'none';
                return;
            }
            
            let total = 0;
            
            cart.forEach(item => {
                const itemTotal = item.price * item.quantity;
                total += itemTotal;
                
                const cartItem = document.createElement('div');
                cartItem.className = 'cart-item';
                cartItem.innerHTML = `
                    <div class="cart-item-details">
                        <div class="cart-item-name">${item.name}</div>
                        <div class="cart-item-category">${getCategoryName(item.category)}</div>
                        <div class="cart-item-price">Rp ${itemTotal.toLocaleString('id-ID')}</div>
                    </div>
                    <div class="cart-item-controls">
                        <button class="quantity-btn minus">-</button>
                        <span class="quantity">${item.quantity}</span>
                        <button class="quantity-btn plus">+</button>
                        <button class="remove-btn">Hapus</button>
                    </div>
                `;
                
                // Add event listeners to buttons
                const minusBtn = cartItem.querySelector('.minus');
                const plusBtn = cartItem.querySelector('.plus');
                const removeBtn = cartItem.querySelector('.remove-btn');
                
                minusBtn.addEventListener('click', () => updateQuantity(item.id, -1));
                plusBtn.addEventListener('click', () => updateQuantity(item.id, 1));
                removeBtn.addEventListener('click', () => removeFromCart(item.id));
                
                cartItems.appendChild(cartItem);
            });
            
            totalAmount.textContent = total.toLocaleString('id-ID');
            calculateChange();
        }

        // Get category display name
        function getCategoryName(category) {
            const categoryNames = {
                'minuman': 'Minuman',
                'makanan': 'Makanan',
                'alat-tulis': 'Alat Tulis'
            };
            return categoryNames[category] || category;
        }

        // Calculate change
        function calculateChange() {
            const total = getTotalAmount();
            const cash = parseInt(cashAmountInput.value) || 0;
            
            if (cash > 0 && cash >= total) {
                const change = cash - total;
                changeAmount.textContent = change.toLocaleString('id-ID');
                changeDisplay.style.display = 'block';
            } else {
                changeDisplay.style.display = 'none';
            }
        }

        // Get total amount
        function getTotalAmount() {
            return cart.reduce((total, item) => total + (item.price * item.quantity), 0);
        }

        // Clear cart
        function clearCart() {
            if (cart.length === 0) {
                alert('Keranjang sudah kosong!');
                return;
            }
            
            if (confirm('Apakah Anda yakin ingin menghapus semua item dari keranjang?')) {
                cart = [];
                cashAmountInput.value = '';
                updateCart();
            }
        }

        // Checkout process
        function checkout() {
            if (cart.length === 0) {
                alert('Keranjang masih kosong! Silakan tambahkan item terlebih dahulu.');
                return;
            }
            
            const total = getTotalAmount();
            const cash = parseInt(cashAmountInput.value) || 0;
            
            if (cash === 0) {
                alert('Silakan masukkan jumlah tunai!');
                cashAmountInput.focus();
                return;
            }
            
            if (cash < total) {
                alert('Jumlah tunai tidak cukup!');
                cashAmountInput.focus();
                return;
            }
            
            // Record income
            recordIncome(total);
            
            // Show receipt
            showReceipt(total, cash);
        }

        // Record income to all periods - DIPERBAIKI UNTUK KATEGORI
        function recordIncome(total) {
            const now = new Date();
            const dayKey = now.toISOString().split('T')[0]; // YYYY-MM-DD
            const monthKey = now.toISOString().substring(0, 7); // YYYY-MM
            const yearKey = now.getFullYear().toString(); // YYYY
            
            // Hitung breakdown per kategori dari cart
            const categoryBreakdown = {
                minuman: 0,
                makanan: 0,
                "alat-tulis": 0
            };
            
            cart.forEach(item => {
                categoryBreakdown[item.category] += item.price * item.quantity;
            });
            
            // Update daily income dengan kategori
            if (!incomeData.daily[dayKey]) {
                incomeData.daily[dayKey] = {
                    total: 0,
                    categories: { minuman: 0, makanan: 0, "alat-tulis": 0 }
                };
            }
            incomeData.daily[dayKey].total += total;
            incomeData.daily[dayKey].categories.minuman += categoryBreakdown.minuman;
            incomeData.daily[dayKey].categories.makanan += categoryBreakdown.makanan;
            incomeData.daily[dayKey].categories["alat-tulis"] += categoryBreakdown["alat-tulis"];
            
            // Update total kategori
            incomeData.categories.minuman += categoryBreakdown.minuman;
            incomeData.categories.makanan += categoryBreakdown.makanan;
            incomeData.categories["alat-tulis"] += categoryBreakdown["alat-tulis"];
            
            // Update monthly income (dari hari 1 bulan ini)
            const daysInMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
            
            // Jika hari terakhir bulan, hitung total bulanan
            if (now.getDate() === daysInMonth) {
                let monthlyTotal = 0;
                let monthlyCategories = { minuman: 0, makanan: 0, "alat-tulis": 0 };
                
                for (let day = 1; day <= daysInMonth; day++) {
                    const dateKey = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    if (incomeData.daily[dateKey]) {
                        monthlyTotal += incomeData.daily[dateKey].total;
                        monthlyCategories.minuman += incomeData.daily[dateKey].categories.minuman;
                        monthlyCategories.makanan += incomeData.daily[dateKey].categories.makanan;
                        monthlyCategories["alat-tulis"] += incomeData.daily[dateKey].categories["alat-tulis"];
                    }
                }
                
                incomeData.monthly[monthKey] = {
                    total: monthlyTotal,
                    categories: monthlyCategories
                };
            }
            
            // Update yearly income (jika Desember)
            if (now.getMonth() === 11) {
                let yearlyTotal = 0;
                let yearlyCategories = { minuman: 0, makanan: 0, "alat-tulis": 0 };
                
                for (let month = 0; month < 12; month++) {
                    const monthKey = `${now.getFullYear()}-${String(month + 1).padStart(2, '0')}`;
                    if (incomeData.monthly[monthKey]) {
                        yearlyTotal += incomeData.monthly[monthKey].total;
                        yearlyCategories.minuman += incomeData.monthly[monthKey].categories.minuman;
                        yearlyCategories.makanan += incomeData.monthly[monthKey].categories.makanan;
                        yearlyCategories["alat-tulis"] += incomeData.monthly[monthKey].categories["alat-tulis"];
                    }
                }
                
                incomeData.yearly[yearKey] = {
                    total: yearlyTotal,
                    categories: yearlyCategories
                };
            }
            
            saveIncomeData();
        }

        // Render dashboard - DIPERBAIKI
        function renderDashboard() {
            renderDailyIncome();
            renderMonthlyIncome();
            renderYearlyIncome();
            renderCategoryBreakdown(); // TAMBAHKAN INI
        }

        // Render daily income - DIPERBAIKI DENGAN BREAKDOWN KATEGORI
        function renderDailyIncome() {
            dailyIncomeList.innerHTML = '';
            
            const dailyEntries = Object.entries(incomeData.daily);
            
            if (dailyEntries.length === 0) {
                dailyIncomeList.innerHTML = '<div class="no-data">Belum ada data pendapatan harian</div>';
                return;
            }
            
            // Sort by date (newest first)
            dailyEntries.sort((a, b) => new Date(b[0]) - new Date(a[0]));
            
            dailyEntries.forEach(([date, data]) => {
                const dateObj = new Date(date);
                const formattedDate = dateObj.toLocaleDateString('id-ID', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                
                const incomeItem = document.createElement('div');
                incomeItem.className = 'income-item';
                incomeItem.innerHTML = `
                    <div class="income-date">${formattedDate}</div>
                    <div class="income-total">Rp ${data.total.toLocaleString('id-ID')}</div>
                `;
                
                // TAMBAHKAN BREAKDOWN KATEGORI UNTUK SETIAP HARI
                const breakdown = document.createElement('div');
                breakdown.className = 'category-breakdown';
                breakdown.innerHTML = `
                    <div class="category-item">
                        <span class="category-name">Minuman:</span>
                        <span class="category-amount">Rp ${data.categories.minuman.toLocaleString('id-ID')}</span>
                    </div>
                    <div class="category-item">
                        <span class="category-name">Makanan:</span>
                        <span class="category-amount">Rp ${data.categories.makanan.toLocaleString('id-ID')}</span>
                    </div>
                    <div class="category-item">
                        <span class="category-name">Alat Tulis:</span>
                        <span class="category-amount">Rp ${data.categories["alat-tulis"].toLocaleString('id-ID')}</span>
                    </div>
                `;
                
                incomeItem.appendChild(breakdown);
                dailyIncomeList.appendChild(incomeItem);
            });
        }

        // Render monthly income - DIPERBAIKI DENGAN BREAKDOWN KATEGORI
        function renderMonthlyIncome() {
            monthlyIncomeList.innerHTML = '';
            
            const monthlyEntries = Object.entries(incomeData.monthly);
            
            if (monthlyEntries.length === 0) {
                monthlyIncomeList.innerHTML = '<div class="no-data">Belum ada data pendapatan bulanan</div>';
                return;
            }
            
            // Sort by date (newest first)
            monthlyEntries.sort((a, b) => new Date(b[0]) - new Date(a[0]));
            
            monthlyEntries.forEach(([month, data]) => {
                const [year, monthNum] = month.split('-');
                const monthNames = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 
                                   'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
                const monthName = monthNames[parseInt(monthNum) - 1];
                
                const incomeItem = document.createElement('div');
                incomeItem.className = 'income-item';
                incomeItem.innerHTML = `
                    <div class="income-date">${monthName} ${year}</div>
                    <div class="income-total">Rp ${data.total.toLocaleString('id-ID')}</div>
                `;
                
                // TAMBAHKAN BREAKDOWN KATEGORI UNTUK SETIAP BULAN
                const breakdown = document.createElement('div');
                breakdown.className = 'category-breakdown';
                breakdown.innerHTML = `
                    <div class="category-item">
                        <span class="category-name">Minuman:</span>
                        <span class="category-amount">Rp ${data.categories.minuman.toLocaleString('id-ID')}</span>
                    </div>
                    <div class="category-item">
                        <span class="category-name">Makanan:</span>
                        <span class="category-amount">Rp ${data.categories.makanan.toLocaleString('id-ID')}</span>
                    </div>
                    <div class="category-item">
                        <span class="category-name">Alat Tulis:</span>
                        <span class="category-amount">Rp ${data.categories["alat-tulis"].toLocaleString('id-ID')}</span>
                    </div>
                `;
                
                incomeItem.appendChild(breakdown);
                monthlyIncomeList.appendChild(incomeItem);
            });
        }

        // Render yearly income - DIPERBAIKI DENGAN BREAKDOWN KATEGORI
        function renderYearlyIncome() {
            yearlyIncomeList.innerHTML = '';
            
            const yearlyEntries = Object.entries(incomeData.yearly);
            
            if (yearlyEntries.length === 0) {
                yearlyIncomeList.innerHTML = '<div class="no-data">Belum ada data pendapatan tahunan</div>';
                return;
            }
            
            // Sort by year (newest first)
            yearlyEntries.sort((a, b) => parseInt(b[0]) - parseInt(a[0]));
            
            yearlyEntries.forEach(([year, data]) => {
                const incomeItem = document.createElement('div');
                incomeItem.className = 'income-item';
                incomeItem.innerHTML = `
                    <div class="income-date">Tahun ${year}</div>
                    <div class="income-total">Rp ${data.total.toLocaleString('id-ID')}</div>
                `;
                
                // TAMBAHKAN BREAKDOWN KATEGORI UNTUK SETIAP TAHUN
                const breakdown = document.createElement('div');
                breakdown.className = 'category-breakdown';
                breakdown.innerHTML = `
                    <div class="category-item">
                        <span class="category-name">Minuman:</span>
                        <span class="category-amount">Rp ${data.categories.minuman.toLocaleString('id-ID')}</span>
                    </div>
                    <div class="category-item">
                        <span class="category-name">Makanan:</span>
                        <span class="category-amount">Rp ${data.categories.makanan.toLocaleString('id-ID')}</span>
                    </div>
                    <div class="category-item">
                        <span class="category-name">Alat Tulis:</span>
                        <span class="category-amount">Rp ${data.categories["alat-tulis"].toLocaleString('id-ID')}</span>
                    </div>
                `;
                
                incomeItem.appendChild(breakdown);
                yearlyIncomeList.appendChild(incomeItem);
            });
        }

        // FUNGSI BARU: Render category breakdown
        function renderCategoryBreakdown() {
            categoryIncomeList.innerHTML = '';
            
            const totalAll = incomeData.categories.minuman + incomeData.categories.makanan + incomeData.categories["alat-tulis"];
            
            if (totalAll === 0) {
                categoryIncomeList.innerHTML = '<div class="no-data">Belum ada data pendapatan per kategori</div>';
                return;
            }
            
            // Hitung persentase
            const percentageMinuman = ((incomeData.categories.minuman / totalAll) * 100).toFixed(1);
            const percentageMakanan = ((incomeData.categories.makanan / totalAll) * 100).toFixed(1);
            const percentageAlatTulis = ((incomeData.categories["alat-tulis"] / totalAll) * 100).toFixed(1);
            
            const breakdownHTML = `
                <div class="income-card">
                    <div class="income-period">Total Keseluruhan</div>
                    <div class="income-amount">Rp ${totalAll.toLocaleString('id-ID')}</div>
                    
                    <div class="category-breakdown">
                        <div class="category-item">
                            <span class="category-name">Minuman:</span>
                            <span class="category-amount">
                                Rp ${incomeData.categories.minuman.toLocaleString('id-ID')} (${percentageMinuman}%)
                            </span>
                        </div>
                        <div class="category-item">
                            <span class="category-name">Makanan:</span>
                            <span class="category-amount">
                                Rp ${incomeData.categories.makanan.toLocaleString('id-ID')} (${percentageMakanan}%)
                            </span>
                        </div>
                        <div class="category-item">
                            <span class="category-name">Alat Tulis:</span>
                            <span class="category-amount">
                                Rp ${incomeData.categories["alat-tulis"].toLocaleString('id-ID')} (${percentageAlatTulis}%)
                            </span>
                        </div>
                        <div class="category-item category-total">
                            <span class="category-name">Total:</span>
                            <span class="category-amount">Rp ${totalAll.toLocaleString('id-ID')}</span>
                        </div>
                    </div>
                </div>
            `;
            
            categoryIncomeList.innerHTML = breakdownHTML;
        }

        // Show receipt
        function showReceipt(total, cash) {
            // Set current date and time
            const now = new Date();
            receiptDate.textContent = now.toLocaleString('id-ID');
            
            // Populate receipt items
            receiptItems.innerHTML = '';
            
            cart.forEach(item => {
                const itemTotal = item.price * item.quantity;
                
                const receiptItem = document.createElement('div');
                receiptItem.className = 'receipt-item';
                receiptItem.innerHTML = `
                    <span>${item.name} x${item.quantity}</span>
                    <span>Rp ${itemTotal.toLocaleString('id-ID')}</span>
                `;
                
                receiptItems.appendChild(receiptItem);
            });
            
            const change = cash - total;
            
            receiptTotal.textContent = total.toLocaleString('id-ID');
            receiptCash.textContent = cash.toLocaleString('id-ID');
            receiptChange.textContent = change.toLocaleString('id-ID');
            
            // Show receipt
            receipt.style.display = 'block';
            
            // Scroll to receipt
            receipt.scrollIntoView({ behavior: 'smooth' });
        }

        // Close receipt
        function closeReceipt() {
            receipt.style.display = 'none';
            clearCart();
        }

        // Print receipt - SOLUSI LEBIH SEDERHANA
        function printReceipt() {
            // Buat HTML struk tanpa tombol
            const receiptHTML = `
                <div class="receipt-header">
                    <div class="store-logo">🍵</div>
                    <div class="store-name">Esteh Santri</div>
                    <div class="store-slogan">Segarkan Harimu dengan Cita Rasa Santri</div>
                    <div class="store-address">Jl. Pesantren No. 123, Kab. Jombang, Jawa Timur</div>
                    <div class="receipt-date">${document.getElementById('receiptDate').textContent}</div>
                </div>
                
                <div class="receipt-items">
                    ${document.getElementById('receiptItems').innerHTML}
                </div>
                
                <div class="receipt-totals">
                    <div class="receipt-total-line">
                        <span>Total:</span>
                        <span>${document.getElementById('receiptTotal').parentNode.innerHTML}</span>
                    </div>
                    <div class="receipt-total-line">
                        <span>Tunai:</span>
                        <span>${document.getElementById('receiptCash').parentNode.innerHTML}</span>
                    </div>
                    <div class="receipt-total-line receipt-change">
                        <span>Kembalian:</span>
                        <span>${document.getElementById('receiptChange').parentNode.innerHTML}</span>
                    </div>
                </div>
                
                <div class="receipt-footer">
                    Terima kasih atas kunjungan Anda<br>
                    Selamat menikmati minuman kami!
                </div>
            `;

            // Buat window baru untuk mencetak
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Cetak Struk - Esteh Santri</title>
                    <style>
                        body {
                            font-family: 'Courier New', monospace;
                            font-size: 12px;
                            margin: 0;
                            padding: 10px;
                            background: white;
                        }
                        .receipt {
                            width: 100%;
                            max-width: 70mm;
                            margin: 0 auto;
                            padding: 5px;
                        }
                        .receipt-header {
                            text-align: center;
                            margin-bottom: 10px;
                            padding-bottom: 5px;
                            border-bottom: 1px dashed #000;
                        }
                        .store-logo {
                            font-size: 24px;
                            margin-bottom: 3px;
                        }
                        .store-name {
                            font-size: 16px;
                            font-weight: bold;
                            margin-bottom: 3px;
                        }
                        .store-slogan {
                            font-size: 10px;
                            margin-bottom: 3px;
                        }
                        .store-address {
                            font-size: 9px;
                            margin-bottom: 8px;
                        }
                        .receipt-date {
                            font-size: 10px;
                            margin-bottom: 8px;
                        }
                        .receipt-items {
                            margin-bottom: 10px;
                        }
                        .receipt-item {
                            display: flex;
                            justify-content: space-between;
                            margin-bottom: 2px;
                            font-size: 10px;
                        }
                        .receipt-totals {
                            border-top: 1px dashed #000;
                            padding-top: 8px;
                            margin-top: 8px;
                        }
                        .receipt-total-line {
                            display: flex;
                            justify-content: space-between;
                            margin-bottom: 2px;
                            font-size: 10px;
                        }
                        .receipt-change {
                            font-weight: bold;
                        }
                        .receipt-footer {
                            text-align: center;
                            margin-top: 10px;
                            font-size: 8px;
                            border-top: 1px dashed #000;
                            padding-top: 8px;
                        }
                        @media print {
                            body { 
                                margin: 0; 
                                padding: 0;
                            }
                            .receipt {
                                width: 70mm;
                                max-width: 70mm;
                            }
                        }
                    </style>
                </head>
                <body>
                    <div class="receipt">
                        ${receiptHTML}
                    </div>
                    <script>
                        window.onload = function() {
                            window.print();
                            setTimeout(function() {
                                window.close();
                            }, 500);
                        };
                    <\/script>
                </body>
                </html>
            `);
            printWindow.document.close();
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>